server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;
    include /etc/nginx/snippets/no-autoindex.conf;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name example.com www.example.com;

    include /etc/nginx/snippets/no-autoindex.conf;

    root /var/www/blog;
    index index.php index.html;

    ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # TLS settings 1.2, 1.3 only
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    # For a full, current cipher suite & hardening, generate from Mozillaâ€™s tool.
    # https://ssl-config.mozilla.org/  (choose: nginx, Intermediate)
    # For HSTS uncomment below (beware of preloading)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # add_header X-Powered-By "Abdessalam's Engine 1.0" always; # set if needed
    # add_header Permissions-Policy "geolocation=(), microphone=()" always; # set if needed

    # adjust as needed
    client_max_body_size 64m; 

    # WordPress permalinks
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # PHP via PHP-FPM 8.4 with CDN-friendly real IP headers
    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REMOTE_ADDR $remote_addr;
        # These are optional, uncomment if needed when using a reverse proxy or CDN
        # fastcgi_param HTTP_X_FORWARDED_FOR $remote_addr;
        # fastcgi_param HTTP_CLIENT_IP       $remote_addr;
        # fastcgi_param X-Real-IP            $remote_addr;
        # fastcgi_param HTTP_X_REAL_IP       $remote_addr;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        fastcgi_buffers 16 64k;
        fastcgi_buffer_size 128k;
        fastcgi_hide_header X-Powered-By;
        proxy_hide_header   X-Powered-By;
        error_page 404 = @wp_404;
    }
    location ~* \.(?:css|js|mjs|map|jpg|jpeg|gif|png|svg|webp|ico|ttf|otf|woff2?)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
    # Use a harmless status (418) to trigger an internal redirect to WP's front controller
    error_page 404 418 = @wp_404;

    # Named location: hand off errors to PHP-FPM running WordPress
    location @wp_404 {
        internal;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param DOCUMENT_URI /index.php;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
    }
    # Block access to sensitive files
    if ($request_uri ~* (^|/)(config\.php|wordfence-waf\.php|wp-config-sample\.php|wp-admin/install\.php|readme\.html|readme\.txt|install\.php|license\.txt|php\.ini|hidemywp\.conf|bb-config\.php|xmlrpc\.php|error_log|debug\.log)(/|$)) {
        return 418;
    }
    # Block dotfiles (still allow ACME challenges)
    location ~ /\.(?!well-known) {
        return 418;   # internally renders WP 404
    }
    # Block any .conf file accesses
    location ~* \.conf(?:$|/) {
        return 418;
    }
    # Block PHP in uploads
    location ~* /wp-content/uploads/.*\.php$ {
        return 418;
    }
    location ~* /(?:uploads|files)/.*\.ph(?:p[3457]?|t|tml)$ { return 418; }
    # Robots TXT logging off
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }
    # If you are running a single WordPress site, Comment the next 2 lines
    access_log /var/log/nginx/example.com.access.log main;
    error_log  /var/log/nginx/example.com.error.log warn; 
}
